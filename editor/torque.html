<!DOCTYPE html>
<html>
<head>
  <title>Odyssey.js</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
  <link rel="stylesheet" href="//cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/themes/css/cartodb.css" />
  <link rel="stylesheet" href="css/slides.css" />
</head>
<body>
  <div id="map" style="width: 100%; height: 100%"></div>
  <div id="slides_container">
    <div id="slides">
    </div>
  </div>
  <div id="credits">
    <span class="title" id="title">Title</span>
    <span class="author"><b id="author">By Name using</b> <a href="#">Odyssey.js</a><span>
  </div>

  <script src="//maps.googleapis.com/maps/api/js?sensor=false"></script>
  <script src="//cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/cartodb.js"></script>
  <script src="../vendor/d3.v3.js" charset="UTF-8"></script>
  <script src="../dist/odyssey.js" charset="UTF-8"></script>

  <script>
    function torque(layer) {
      function _torque() {}

      _torque.reach = function (slide, torqueLayer) {
        var i = (slide.get('step') || 0);

        var l = i*$('.slider').width()/torqueLayer.options.steps,
            tooltip = ['<div class="slide-tip" style="left:'+l+'px">',
                       '<span class="tip">'+slide.get('tip')+'</span>',
                       '<div class="tooltip">'+slide.html()+'</div>',
                       '</div>'].join("\n");

        $('.slider').append(tooltip);

        var t = O.Trigger({});
        function check(changes) {
          if (i === changes.step) {
            t.trigger();
          }
        };
        layer.on('change:time', check);
        t.clear = function() {
          layer.off('change:time', check);
        }
        return t;
      }

      _torque.pause = function() {
        return O.Action(function (){
          layer.pause();
        });
      }

      _torque.play = function() {
        return O.Action(function () {
          layer.play()
        });
      }

      return _torque;
    }

    O.Template({
      actions: {
        'move map to': function() {
          var center = this.map.getCenter()
          return 'S.map.actions.setView([' + center.lat.toFixed(4) + ', ' + center.lng.toFixed(4) + '],' + this.map.getZoom() + ')'
        },
        'show marker': function() {
          var center = this.map.getCenter()
          return 'L.marker([' + center.lat.toFixed(4) + ', ' + center.lng.toFixed(4) + ']).actions.addRemove(S.map)';
        },
        'sleep': function() {
          return "O.Actions.Sleep(1000)";
        },
        'insert time': function() {
          return "- step: " + this.torqueLayer.getStep()
        },
        'pause': function() {
          return "S.torqueLayer.actions.pause()";
        },
        'play': function() {
          return "S.torqueLayer.actions.play()";
        }
      },

      init: function() {
        var self = this;

        var map = L.map('map').setView([0, 0.0], 4);
        L.tileLayer('http://{s}.api.cartocdn.com/base-light/{z}/{x}/{y}.png', {
          attribution: 'data OSM - map CartoDB'
        }).addTo(map);

        var slides = O.Actions.Slides('slides');
        var story = O.Story()

        this.map = map;
        this.story = story;
        this.slides = slides;
      },

      _resetActions: function(actions) {
        for(var i = 0; i < actions.length; ++i) {
          var slide = actions[i];
          var tmpl = "<div class='slide' style='display:none'>"
          tmpl += slide.html();
          tmpl += "</div>";
          document.getElementById('slides').innerHTML += tmpl;

          var ac = O.Parallel.apply(window, [this.slides.activate(i), slide(this)]);

          this.story.addState(
            torque(this.torqueLayer).reach(slide, this.torqueLayer),
            ac
          )
        }
      },

      update: function(actions) {
        var self = this;

        if (this.map && this.torqueLayer && ("http://"+self.torqueLayer.options.user+".cartodb.com/api/v2/viz/"+self.torqueLayer.options.stat_tag+"/viz.json" !== actions.global.vizjson)) {
          this.map.removeLayer(this.torqueLayer);

          $('.cartodb-timeslider').remove();
          $('.cartodb-legend-stack').remove();
          this.torqueLayer = null;
          this.created = false;
        }

        if (!this.torqueLayer) {
          if (!this.created) { // sendCode debounce < vis loader :(
            cdb.vis.Loader.get(actions.global.vizjson, function(vizjson) {
              cartodb.createLayer(self.map, vizjson)
                .done(function(layer) {
                  self.map.fitBounds(vizjson.bounds);

                  actions.global.duration && layer.setDuration(actions.global.duration);

                  self.torqueLayer = layer;
                  self.torqueLayer.actions = torque(self.torqueLayer);
                  self.map.addLayer(self.torqueLayer);

                  self._resetActions(actions);
                }).on('error', function(err) {
                  console.log("some error occurred: " + err);
                });
            });

            this.created = true;
          }

          return;
        }

        this.story.clear();

        // update footer title and author
        var title_ = actions.global.title === undefined ? '' : actions.global.title,
            author_ = actions.global.author === undefined ? 'Using' : 'By '+actions.global.author+' using';

        document.getElementById('title').innerHTML = title_;
        document.getElementById('author').innerHTML = author_;
        document.title = title_ + " | " + author_ +' Odyssey.js';

        document.getElementById('slides').innerHTML = '';

        $('.slide-tip').remove();

        this._resetActions(actions);

        if (actions.global.duration) {
          this.torqueLayer.stop();
          this.torqueLayer.setDuration(actions.global.duration);
          this.torqueLayer.play()
        }
      }
    });
  </script>
</body>
</html>

